generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String                @id @default(uuid())
  email         String                @unique
  password      String
  firstName     String?
  lastName      String?
  phone         String?
  userType      String                @default("PARTICULIER")
  role          String                @default("USER") // USER ou ADMIN
  profilePhoto      String?
  googleId          String?           @unique
  companyName       String?
  vatNumber         String?
  address           String?           @db.Text
  country           String?
  accommodationType String?           @db.Text // JSON array of accommodation types
  createdAt         DateTime          @default(now())
  updatedAt     DateTime              @updatedAt
  invoices      Invoice[]
  livrets       Livret[]
  subscriptions Subscription[]
  passwordResetTokens PasswordResetToken[]
  affiliate     Affiliate?
  referredBy    AffiliateReferral[]   @relation("ReferredUser")
  blogArticles  BlogArticle[]

  @@map("users")
}

model Livret {
  id               String         @id @default(uuid())
  name             String
  address          String?
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  userId           String
  welcomeTitle     String?
  welcomeSubtitle  String?
  backgroundImage  String?
  showProfilePhoto Boolean        @default(true)
  titleFont        String?
  titleColor       String?        @default("#FFFFFF")
  subtitleColor    String?        @default("#FFFFFF")
  tileColor        String?        @default("#000000B3")
  iconColor        String?        @default("#FFFFFF")
  languages        String?
  qrCode           String?        @unique
  translations     String?         @db.Text
  type             String         @default("TRIAL")    // TRIAL, ANNUAL, SEASONAL
  seasonalEndDate  DateTime?                            // Date d'expiration pour les livrets saisonniers
  duplicatedFromId String?                              // ID du livret source de la duplication
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  modules          Module[]
  statistics       Statistic[]
  chatDocuments    ChatDocument[]

  @@map("livrets")
}

model Module {
  id           String   @id @default(uuid())
  type         String
  name         String?
  isActive     Boolean  @default(true)
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  livretId     String
  content      String?         @db.Text
  translations String?         @db.Text
  livret       Livret   @relation(fields: [livretId], references: [id], onDelete: Cascade)

  @@map("modules")
}

model Statistic {
  id         String   @id @default(uuid())
  moduleType String?
  livretId   String
  viewedAt   DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  livret     Livret   @relation(fields: [livretId], references: [id], onDelete: Cascade)

  @@map("statistics")
}

model Subscription {
  id                   String    @id @default(uuid())
  userId               String
  plan                 String    @default("TRIAL")
  status               String    @default("ACTIVE")
  startDate            DateTime  @default(now())
  endDate              DateTime?
  trialDaysLeft        Int?      @default(14)
  stripeSubscriptionId String?   @unique
  stripeCustomerId     String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  stripeSessionId      String?
  quantity             Int       @default(1)   // Nombre de livrets inclus dans l'abonnement
  invoices             Invoice[]
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Invoice {
  id                    String        @id @default(uuid())
  invoiceNumber         String?       @unique
  userId                String
  subscriptionId        String?
  amount                Float
  currency              String        @default("EUR")
  status                String        @default("PENDING")
  stripeInvoiceId       String?       @unique
  stripePaymentIntentId String?
  pdfUrl                String?
  createdAt             DateTime      @default(now())
  paidAt                DateTime?
  subscription          Subscription? @relation(fields: [subscriptionId], references: [id])
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

model ChatDocument {
  id          String   @id @default(uuid())
  livretId    String
  title       String   // Titre du document
  content     String   @db.Text // Contenu texte du document
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  livret      Livret   @relation(fields: [livretId], references: [id], onDelete: Cascade)

  @@map("chat_documents")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Affiliate {
  id              String    @id @default(uuid())
  userId          String    @unique
  affiliateCode   String    @unique      // Code unique pour le lien d'affiliation
  companyName     String                 // Nom de la soci√©t√© de l'affili√©
  vatNumber       String                 // Num√©ro de TVA obligatoire
  contactName     String                 // Nom + pr√©nom du responsable
  email           String                 // Email de facturation
  address         String?   @db.Text     // Adresse compl√®te
  country         String?                // Pays
  iban            String?                // IBAN pour les paiements
  commissionRate  Float     @default(30) // Taux de commission en %
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED, SUSPENDED
  totalEarnings   Float     @default(0)  // Total des gains cumul√©s
  totalPaid       Float     @default(0)  // Total d√©j√† pay√©
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals       AffiliateReferral[]

  @@map("affiliates")
}

model AffiliateReferral {
  id               String    @id @default(uuid())
  affiliateId      String
  referredUserId   String?                   // User inscrit via le lien d'affiliation
  subscriptionId   String?                   // Abonnement souscrit
  saleAmount       Float     @default(0)     // Montant HT de la vente
  commissionAmount Float     @default(0)     // Montant de la commission (30%)
  status           String    @default("PENDING") // PENDING, VALIDATED, PAID, CANCELLED
  periodMonth      Int?                      // Mois de la cl√¥ture (1-12)
  periodYear       Int?                      // Ann√©e de la cl√¥ture
  paidAt           DateTime?                 // Date de paiement
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  affiliate        Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  referredUser     User?     @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: SetNull)

  @@map("affiliate_referrals")
}

model BlogArticle {
  id          String    @id @default(uuid())
  title       String
  slug        String    @unique
  excerpt     String    @db.Text
  content     String    @db.LongText
  thumbnail   String?   @db.Text      // URL de la vignette (upload ou Pexels)
  category    String                   // conseils, avantages, technologie, temoignages, actualites
  tags        String?   @db.Text       // JSON array de tags
  status      String    @default("DRAFT") // DRAFT, PUBLISHED
  featured    Boolean   @default(false)
  readTime    String?                  // "5 min"
  metaTitle   String?                  // SEO title
  metaDesc    String?   @db.Text       // SEO description
  authorId    String
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("blog_articles")
}

model BlogCategory {
  id        String   @id @default(uuid())
  slug      String   @unique            // identifiant unique (ex: "conseils")
  label     String                      // Nom affich√© (ex: "Conseils")
  emoji     String   @default("üìÅ")     // Emoji de la cat√©gorie
  gradient  String   @default("from-primary to-pink-500") // Classes gradient Tailwind
  isActive  Boolean  @default(true)     // Actif ou non
  order     Int      @default(0)        // Ordre d'affichage
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blog_categories")
}
